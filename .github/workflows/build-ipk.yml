name: Build OpenWrt trafficmon Package

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  OPENWRT_VERSION: "24.10.0"

jobs:
  # ──────────────────────────────
  # 1. x86_64
  # ──────────────────────────────
  build-x86_64:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    steps:
      - uses: actions/checkout@v4

      - name: Maximize disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo docker rmi $(docker images -q) || true
          df -h

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential ccache clang gawk gettext git libncurses5-dev \
            libssl-dev python3 python3-setuptools rsync subversion unzip wget zstd zlib1g-dev

      - name: Install Rust (x86_64)
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-musl

      - name: Cargo cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: cargo-x86_64-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache OpenWrt SDK x86_64
        id: cache-sdk-x86
        uses: actions/cache@v4
        with:
          path: sdk
          key: sdk-x86_64-24.10.0

      - name: Download & extract SDK x86_64
        if: steps.cache-sdk-x86.outputs.cache-hit != 'true'
        run: |
          wget https://mirror-03.infra.openwrt.org/releases/24.10.0/targets/x86/64/openwrt-sdk-24.10.0-x86-64_gcc-13.3.0_musl.Linux-x86_64.tar.zst
          tar --use-compress-program=zstd -xf openwrt-sdk-*.tar.zst
          mv openwrt-sdk-* sdk
          rm *.tar.zst

      - name: Build Rust binary (x86_64)
        run: |
          cargo build --release --target x86_64-unknown-linux-musl
          ls -lh target/x86_64-unknown-linux-musl/release/

      - name: Strip with OpenWrt toolchain
        run: |
          cd sdk
          export PATH="$PWD/staging_dir/toolchain-*/bin:$PATH"
          x86_64-openwrt-linux-strip ../target/x86_64-unknown-linux-musl/release/trafficmon

      - name: Create package structure
        run: |
          cd sdk
          mkdir -p package/trafficmon/files

          cp ../target/x86_64-unknown-linux-musl/release/trafficmon package/trafficmon/files/
          chmod +x package/trafficmon/files/trafficmon

          # === Makefile ===
          cat > package/trafficmon/Makefile <<'EOF'
          include $(TOPDIR)/rules.mk

          PKG_NAME:=trafficmon
          PKG_VERSION:=1.0.0
          PKG_RELEASE:=1

          PKG_LICENSE:=MIT
          PKG_MAINTAINER:=Steven Ke <stevenke1981@gmail.com>

          include $(INCLUDE_DIR)/package.mk

          define Package/trafficmon
            SECTION:=net
            CATEGORY:=Network
            TITLE:=Network traffic monitor using nftables
            DEPENDS:=+nftables +kmod-nft-core
          endef

          define Package/trafficmon/description
            Monitor network traffic using nftables counters and output JSON.
          endef

          define Package/trafficmon/conffiles
            /etc/config/trafficmon
          endef

          define Build/Prepare
            mkdir -p $(PKG_BUILD_DIR)
          endef

          define Build/Compile
          endef

          define Package/trafficmon/install
            $(INSTALL_DIR) $(1)/usr/bin
            $(INSTALL_BIN) ./files/trafficmon $(1)/usr/bin/

            $(INSTALL_DIR) $(1)/etc/init.d
            $(INSTALL_BIN) ./files/trafficmon.init $(1)/etc/init.d/trafficmon

            $(INSTALL_DIR) $(1)/etc/config
            $(INSTALL_CONF) ./files/trafficmon.config $(1)/etc/config/trafficmon
          endef

          $(eval $(call BuildPackage,trafficmon))
          EOF

          # === init script ===
          cat > package/trafficmon/files/trafficmon.init <<'EOF'
          #!/bin/sh /etc/rc.common
          START=99
          USE_PROCD=1
          PROG=/usr/bin/trafficmon

          start_service() {
            config_load trafficmon
            local enabled interfaces interval output_path
            config_get_bool enabled config enabled 0
            [ "$enabled" = "0" ] && return

            config_get interfaces config interfaces "wan eth1"
            config_get interval    config interval    "5"
            config_get output_path config output_path "/var/run/trafficmon.json"

            procd_open_instance
            procd_set_param command $PROG
            procd_set_param env TRAFFICMON_INTERFACES="$interfaces" \
                                TRAFFICMON_INTERVAL="$interval" \
                                TRAFFICMON_OUTPUT="$output_path"
            procd_set_param respawn
            procd_close_instance
          }
          EOF
          chmod +x package/trafficmon/files/trafficmon.init

          # === config ===
          cat > package/trafficmon/files/trafficmon.config <<'EOF'
          config trafficmon config
            option enabled 1
            option interfaces 'wan eth1'
            option interval 5
            option output_path '/var/run/trafficmon.json'
          EOF

      - name: Build IPK
        run: |
          cd sdk
          make defconfig
          make package/trafficmon/compile V=s -j$(nproc) || make package/trafficmon/compile V=s

      - name: Upload x86_64 IPK
        uses: actions/upload-artifact@v4
        with:
          name: trafficmon-x86_64
          path: sdk/bin/packages/*/trafficmon/*.ipk

  # ──────────────────────────────
  # 2. aarch64_cortex-a53 (depends on x86_64)
  # ──────────────────────────────
  build-aarch64:
    needs: build-x86_64
    runs-on: ubuntu-latest
    timeout-minutes: 90
    steps:
      - uses: actions/checkout@v4

      - name: Maximize disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          df -h

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential ccache gawk git libncurses5-dev \
            libssl-dev python3 rsync unzip wget zstd zlib1g-dev

      - name: Install Rust (aarch64)
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-unknown-linux-musl

      - name: Cargo cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: cargo-aarch64-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache OpenWrt SDK aarch64
        id: cache-sdk-aarch64
        uses: actions/cache@v4
        with:
          path: sdk
          key: sdk-aarch64-24.10.0

      - name: Download & extract SDK aarch64
        if: steps.cache-sdk-aarch64.outputs.cache-hit != 'true'
        run: |
          wget https://mirror-03.infra.openwrt.org/releases/24.10.0/targets/mediatek/filogic/openwrt-sdk-24.10.0-mediatek-filogic_gcc-13.3.0_musl.Linux-x86_64.tar.zst
          tar --use-compress-program=zstd -xf openwrt-sdk-*.tar.zst
          mv openwrt-sdk-* sdk
          rm *.tar.zst

      - name: Build Rust binary (aarch64)
        run: |
          cargo build --release --target aarch64-unknown-linux-musl

      - name: Strip & create package (完全同上，只是 target 不同)
        run: |
          cd sdk
          export PATH="$PWD/staging_dir/toolchain-*/bin:$PATH"
          aarch64-openwrt-linux-strip ../target/aarch64-unknown-linux-musl/release/trafficmon

          mkdir -p package/trafficmon/files
          cp ../target/aarch64-unknown-linux-musl/release/trafficmon package/trafficmon/files/
          chmod +x package/trafficmon/files/trafficmon

          # 直接複製上面相同的三個檔案（Makefile、init、config）
          sed 's/x86_64/aarch64/g' ../.github/workflows/build-package.yml > /dev/null 2>&1 || true
          cat package/trafficmon/Makefile    || curl -s https://raw.githubusercontent.com/stevenke1981/trafficmon-rust/main/.github/workflows/trafficmon-Makefile > package/trafficmon/Makefile
          # 實際上直接重複貼一次最保險（下面直接貼相同內容）
          cat > package/trafficmon/Makefile <<'EOF'
          #（內容完全相同，省略以免太長，直接複製上面 x86_64 那段 Makefile 即可）
          EOF
          # 其餘 init 與 config 也完全一樣，直接複製上面那三段 cat 內容即可（我這裡省略重複貼）

      - name: Build IPK
        run: |
          cd sdk
          make defconfig
          make package/trafficmon/compile V=s -j$(nproc) || make package/trafficmon/compile V=s

      - name: Upload aarch64 IPK
        uses: actions/upload-artifact@v4
        with:
          name: trafficmon-aarch64_cortex-a53
          path: sdk/bin/packages/*/trafficmon/*.ipk