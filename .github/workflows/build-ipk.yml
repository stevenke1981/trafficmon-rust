name: Build OpenWrt Package

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  OPENWRT_VERSION: "24.10.0"
  MIRROR_URL: "https://mirror-03.infra.openwrt.org/releases/24.10.0/targets"

jobs:
  build-x86_64:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    name: Build for x86_64
    env:
      ARCH: "x86_64"
      TARGET: "x86/64"
      SDK_NAME: "openwrt-sdk-24.10.0-x86-64_gcc-13.3.0_musl.Linux-x86_64.tar.zst"
      RUST_TARGET: "x86_64-unknown-linux-musl"

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Quick disk space cleanup
      run: |
        echo "=== Initial disk space ==="
        df -h / | tail -1
        
        echo "=== Quick cleanup ==="
        # 快速移除已知的大目錄（並行執行）
        {
          sudo rm -rf /usr/share/dotnet &
          sudo rm -rf /usr/local/lib/android &
          sudo rm -rf /opt/hostedtoolcache/CodeQL &
          sudo rm -rf /usr/local/share/chromium &
          sudo rm -rf /usr/local/lib/node_modules &
          wait
        }
        
        # 清理 apt 緩存（不自動移除）
        sudo apt-get clean
        
        # 清理日誌檔案
        sudo find /var/log -name "*.log" -type f -exec truncate -s 0 {} \; 2>/dev/null || true
        
        echo "=== After quick cleanup ==="
        df -h / | tail -1
        echo "Available: $(df -h / | tail -1 | awk '{print $4}')"

    - name: Install dependencies
      run: |
        sudo apt-get update
        # 只安裝必要套件，跳過建議和文檔
        sudo apt-get install -y --no-install-recommends \
          build-essential \
          ca-certificates \
          curl \
          file \
          gawk \
          gettext \
          git \
          libncurses5-dev \
          libssl-dev \
          python3 \
          python3-setuptools \
          wget \
          zstd \
          gcc-aarch64-linux-gnu \
          g++-aarch64-linux-gnu

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ env.RUST_TARGET }}

    - name: Cache Rust
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
        key: ${{ runner.os }}-cargo-${{ env.RUST_TARGET }}-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-${{ env.RUST_TARGET }}-

    - name: Build Rust binary
      env:
        CARGO_TARGET_DIR: ${{ github.workspace }}/target-x86_64
        CARGO_INCREMENTAL: 0
        CARGO_NET_RETRY: 10
        RUSTFLAGS: "-C target-feature=-crt-static"
      run: |
        echo "Building for target: ${{ env.RUST_TARGET }}"
        
        rustup target add ${{ env.RUST_TARGET }}
        
        # 使用更快的編譯設定
        cargo build --release --target ${{ env.RUST_TARGET }} --jobs $(nproc)
        
        echo "Build output:"
        ls -lh target-x86_64/${{ env.RUST_TARGET }}/release/trafficmon
        file target-x86_64/${{ env.RUST_TARGET }}/release/trafficmon

    - name: Cache OpenWrt SDK
      id: cache-sdk-x86
      uses: actions/cache@v4
      with:
        path: sdk-x86_64
        key: openwrt-sdk-${{ env.ARCH }}-${{ env.SDK_NAME }}-v4
        restore-keys: |
          openwrt-sdk-${{ env.ARCH }}-${{ env.SDK_NAME }}-

    - name: Download and extract OpenWrt SDK
      if: steps.cache-sdk-x86.outputs.cache-hit != 'true'
      run: |
        SDK_URL="${{ env.MIRROR_URL }}/${{ env.TARGET }}/${{ env.SDK_NAME }}"
        echo "Downloading SDK from: $SDK_URL"
        
        # 使用 curl 並顯示進度
        curl -L --progress-bar -o sdk.tar.zst "$SDK_URL"
        
        echo "Extracting SDK..."
        tar --use-compress-program=unzstd -xf sdk.tar.zst
        
        SDK_DIR=$(tar --use-compress-program=unzstd -tf sdk.tar.zst | head -1 | cut -f1 -d"/")
        mv "$SDK_DIR" sdk-x86_64
        rm sdk.tar.zst
        
        echo "SDK extracted successfully"

    - name: Setup OpenWrt SDK
      run: |
        cd sdk-x86_64
        
        echo "=== Initial SDK structure ==="
        ls -la | head -5
        
        # 並行安裝工具鏈
        echo "Installing tools and toolchain..."
        make tools/install -j$(nproc) > /dev/null 2>&1
        make toolchain/install -j$(nproc) > /dev/null 2>&1
        
        echo "=== Disk space after toolchain ==="
        df -h / | tail -1

    - name: Create OpenWrt package structure
      run: |
        cd sdk-x86_64
        
        # 創建 package 目錄結構
        mkdir -p package/trafficmon/files
        
        # 複製編譯好的 binary
        cp ../target-x86_64/${{ env.RUST_TARGET }}/release/trafficmon package/trafficmon/files/
        chmod +x package/trafficmon/files/trafficmon
        
        # 建立 Makefile
        cat > package/trafficmon/Makefile << 'EOF'
        include $(TOPDIR)/rules.mk
        
        PKG_NAME:=trafficmon
        PKG_VERSION:=1.0.0
        PKG_RELEASE:=1
        
        PKG_LICENSE:=MIT
        PKG_MAINTAINER:=Steven Ke <stevenke1981@gmail.com>
        
        include $(INCLUDE_DIR)/package.mk
        
        define Package/trafficmon
          SECTION:=net
          CATEGORY:=Network
          TITLE:=Network traffic monitor using nftables
          DEPENDS:=+nftables +kmod-nft-core
          URL:=https://github.com/stevenke1981/trafficmon-rust
        endef
        
        define Package/trafficmon/description
          Monitor network traffic on specified interfaces using nftables counters.
          Outputs statistics to JSON format for easy integration.
        endef
        
        define Package/trafficmon/conffiles
        /etc/config/trafficmon
        endef
        
        define Build/Prepare
        	mkdir -p $(PKG_BUILD_DIR)
        endef
        
        define Build/Compile
        	# Binary already compiled by Rust
        endef
        
        define Package/trafficmon/install
        	$(INSTALL_DIR) $(1)/usr/bin
        	$(INSTALL_BIN) ./files/trafficmon $(1)/usr/bin/
        	
        	$(INSTALL_DIR) $(1)/etc/init.d
        	$(INSTALL_BIN) ./files/trafficmon.init $(1)/etc/init.d/trafficmon
        	
        	$(INSTALL_DIR) $(1)/etc/config
        	$(INSTALL_CONF) ./files/trafficmon.config $(1)/etc/config/trafficmon
        endef
        
        $(eval $(call BuildPackage,trafficmon))
        EOF
        
        # 建立 init 腳本
        cat > package/trafficmon/files/trafficmon.init << 'EOF'
        #!/bin/sh /etc/rc.common
        
        START=99
        STOP=10
        
        USE_PROCD=1
        PROG=/usr/bin/trafficmon
        
        start_service() {
            local enabled
            local interfaces
            local interval
            local output_path
            
            config_load 'trafficmon'
            config_get_bool enabled 'config' 'enabled' 0
            config_get interfaces 'config' 'interfaces' 'eth1 wan'
            config_get interval 'config' 'interval' '5'
            config_get output_path 'config' 'output_path' '/var/run/trafficmon.json'
            
            [ "$enabled" -eq 0 ] && {
                logger -t trafficmon "trafficmon is disabled in config"
                return 1
            }
            
            procd_open_instance
            procd_set_param command $PROG
            procd_set_param env TRAFFICMON_INTERFACES="$interfaces"
            procd_set_param env TRAFFICMON_INTERVAL="$interval"
            procd_set_param env TRAFFICMON_OUTPUT="$output_path"
            procd_set_param respawn 3600 5 5
            procd_set_param stdout 1
            procd_set_param stderr 1
            procd_close_instance
            
            logger -t trafficmon "trafficmon started monitoring: $interfaces"
        }
        
        stop_service() {
            logger -t trafficmon "Stopping trafficmon"
        }
        
        service_triggers() {
            procd_add_reload_trigger "trafficmon"
        }
        
        reload_service() {
            stop
            start
        }
        EOF
        
        # 建立 config 檔
        cat > package/trafficmon/files/trafficmon.config << 'EOF'
        config trafficmon 'config'
        	option enabled '1'
        	option interfaces 'eth1 wan'
        	option interval '5'
        	option output_path '/var/run/trafficmon.json'
        EOF
        
        chmod +x package/trafficmon/files/trafficmon.init

    - name: Build dependencies and package
      run: |
        cd sdk-x86_64
        
        echo "=== Disk space before build ==="
        df -h / | tail -1
        
        # 並行編譯依賴包（抑制詳細輸出）
        echo "Building dependencies..."
        make package/nftables/compile -j$(nproc) > /dev/null 2>&1 || echo "nftables compilation skipped"
        make package/base-files/compile -j$(nproc) > /dev/null 2>&1 || echo "base-files compilation skipped"
        
        # 編譯主要套件（只顯示錯誤）
        echo "Building trafficmon package..."
        make package/trafficmon/compile -j$(nproc)
        
        echo "Creating package index..."
        make package/index -j$(nproc) > /dev/null 2>&1
        
        echo "=== Disk space after build ==="
        df -h / | tail -1

    - name: Collect and verify IPK
      run: |
        cd sdk-x86_64
        
        mkdir -p ../ipk-x86_64
        
        # 尋找並複製 IPK 檔案
        find bin -name "trafficmon*.ipk" -exec cp -v {} ../ipk-x86_64/ \;
        
        if [ ! "$(ls -A ../ipk-x86_64)" ]; then
          echo "ERROR: No IPK files found!"
          exit 1
        fi
        
        echo "=== Generated IPK files ==="
        ls -lh ../ipk-x86_64/

    - name: Upload IPK package
      uses: actions/upload-artifact@v4
      with:
        name: trafficmon-x86_64-ipk
        path: ipk-x86_64/*.ipk
        if-no-files-found: error
        retention-days: 7

    - name: Create build info
      run: |
        cat > build-info-x86_64.txt << EOF
        trafficmon Build Information
        ============================
        
        Architecture: x86_64
        OpenWrt Version: ${{ env.OPENWRT_VERSION }}
        Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        
        Installation:
        opkg install trafficmon_*.ipk
        EOF
        
        cat build-info-x86_64.txt
        
    - name: Upload build info
      uses: actions/upload-artifact@v4
      with:
        name: build-info-x86_64
        path: build-info-x86_64.txt

  build-aarch64:
    needs: build-x86_64
    runs-on: ubuntu-latest
    timeout-minutes: 40
    name: Build for aarch64_cortex-a53
    env:
      ARCH: "aarch64_cortex-a53"
      TARGET: "mediatek/filogic"
      SDK_NAME: "openwrt-sdk-24.10.0-mediatek-filogic_gcc-13.3.0_musl.Linux-x86_64.tar.zst"
      RUST_TARGET: "aarch64-unknown-linux-musl"

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Quick disk cleanup
      run: |
        echo "=== Initial disk space ==="
        df -h / | tail -1
        sudo apt-get clean
        echo "=== After cleanup ==="
        df -h / | tail -1

    - name: Install minimal dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends \
          build-essential \
          ca-certificates \
          curl \
          file \
          gawk \
          gettext \
          git \
          libncurses5-dev \
          libssl-dev \
          python3 \
          wget \
          zstd
        sudo apt-get clean

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ env.RUST_TARGET }}

    - name: Cache Rust
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
        key: ${{ runner.os }}-cargo-${{ env.RUST_TARGET }}-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-${{ env.RUST_TARGET }}-

    - name: Build Rust binary
      env:
        CARGO_TARGET_DIR: ${{ github.workspace }}/target-aarch64
        CARGO_INCREMENTAL: 0
        RUSTFLAGS: "-C target-feature=-crt-static"
      run: |
        echo "Building for target: ${{ env.RUST_TARGET }}"
        rustup target add ${{ env.RUST_TARGET }}
        cargo build --release --target ${{ env.RUST_TARGET }} --jobs $(nproc)
        echo "Build completed"
        ls -lh target-aarch64/${{ env.RUST_TARGET }}/release/trafficmon

    - name: Cache OpenWrt SDK
      id: cache-sdk-aarch64
      uses: actions/cache@v4
      with:
        path: sdk-aarch64
        key: openwrt-sdk-${{ env.ARCH }}-${{ env.SDK_NAME }}-v4
        restore-keys: |
          openwrt-sdk-${{ env.ARCH }}-${{ env.SDK_NAME }}-

    - name: Download and extract OpenWrt SDK
      if: steps.cache-sdk-aarch64.outputs.cache-hit != 'true'
      run: |
        SDK_URL="${{ env.MIRROR_URL }}/${{ env.TARGET }}/${{ env.SDK_NAME }}"
        echo "Downloading SDK..."
        curl -L --progress-bar -o sdk.tar.zst "$SDK_URL"
        tar --use-compress-program=unzstd -xf sdk.tar.zst
        SDK_DIR=$(tar --use-compress-program=unzstd -tf sdk.tar.zst | head -1 | cut -f1 -d"/")
        mv "$SDK_DIR" sdk-aarch64
        rm sdk.tar.zst

    - name: Setup OpenWrt SDK
      run: |
        cd sdk-aarch64
        make tools/install -j$(nproc) > /dev/null 2>&1
        make toolchain/install -j$(nproc) > /dev/null 2>&1

    - name: Create package and build
      run: |
        cd sdk-aarch64
        mkdir -p package/trafficmon/files
        cp ../target-aarch64/${{ env.RUST_TARGET }}/release/trafficmon package/trafficmon/files/
        chmod +x package/trafficmon/files/trafficmon
        
        # 複製 Makefile 和配置檔案
        cp ../sdk-x86_64/package/trafficmon/Makefile package/trafficmon/
        cp ../sdk-x86_64/package/trafficmon/files/trafficmon.init package/trafficmon/files/
        cp ../sdk-x86_64/package/trafficmon/files/trafficmon.config package/trafficmon/files/
        
        # 快速編譯
        make package/trafficmon/compile -j$(nproc)
        make package/index -j$(nproc) > /dev/null 2>&1

    - name: Collect IPK files
      run: |
        cd sdk-aarch64
        mkdir -p ../ipk-aarch64
        find bin -name "trafficmon*.ipk" -exec cp {} ../ipk-aarch64/ \;
        echo "IPK files:"
        ls -lh ../ipk-aarch64/

    - name: Upload IPK package
      uses: actions/upload-artifact@v4
      with:
        name: trafficmon-aarch64-ipk
        path: ipk-aarch64/*.ipk
        if-no-files-found: error

  create-release:
    needs: [build-x86_64, build-aarch64]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    timeout-minutes: 5
    
    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v4
      
    - name: Create release bundle
      run: |
        mkdir -p release
        # 合併所有 IPK 檔案
        find . -name "*.ipk" -exec cp {} release/ \;
        echo "Release contents:"
        ls -la release/

    - name: Upload release
      uses: actions/upload-artifact@v4
      with:
        name: trafficmon-openwrt-packages
        path: release/*
        retention-days: 90