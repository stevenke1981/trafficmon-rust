name: Build OpenWrt Package

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  OPENWRT_VERSION: "24.10.0"
  MIRROR_URL: "https://mirror-03.infra.openwrt.org/releases/24.10.0/targets"

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            target: x86/64
            sdk_name: openwrt-sdk-24.10.0-x86-64_gcc-13.3.0_musl.Linux-x86_64.tar.zst
            rust_target: x86_64-unknown-linux-musl
            
          - arch: aarch64_cortex-a53
            target: mediatek/filogic
            sdk_name: openwrt-sdk-24.10.0-mediatek-filogic_gcc-13.3.0_musl.Linux-x86_64.tar.zst
            rust_target: aarch64-unknown-linux-musl

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Free disk space
      run: |
        sudo rm -rf /usr/local/lib/android || true
        docker rmi $(docker images -q) || true

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential ccache clang g++ gawk gettext git subversion \
          libssl-dev libelf-dev zlib1g-dev python3 unzip rsync wget zstd \
          gcc-aarch64-linux-gnu g++-aarch64-linux-gnu

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ matrix.rust_target }}

    - name: Cache Rust
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
        key: rust-${{ matrix.rust_target }}-${{ hashFiles('**/Cargo.lock') }}

    - name: Cache OpenWrt SDK
      id: cache-sdk
      uses: actions/cache@v4
      with:
        path: sdk
        key: sdk-${{ matrix.arch }}-${{ matrix.sdk_name }}

    - name: Download SDK if not cached
      if: steps.cache-sdk.outputs.cache-hit != 'true'
      run: |
        SDK_URL="${{ env.MIRROR_URL }}/${{ matrix.target }}/${{ matrix.sdk_name }}"
        wget "$SDK_URL"
        tar --zstd -xf "${{ matrix.sdk_name }}"
        SDK_DIR=$(tar --zstd -tf "${{ matrix.sdk_name }}" | head -1 | cut -d/ -f1)
        mv "$SDK_DIR" sdk
        rm -f "${{ matrix.sdk_name }}"

    - name: Verify SDK
      run: |
        ls -l sdk
        echo "SDK OK"

    - name: Update SDK feeds
      if: steps.cache-sdk.outputs.cache-hit != 'true'
      run: |
        cd sdk
        sed -i '/luci/d' feeds.conf.default
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Build Rust binary
      run: |
        cargo build --release --target ${{ matrix.rust_target }}
        mkdir -p output
        cp target/${{ matrix.rust_target }}/release/trafficmon output/trafficmon

    - name: Strip binary
      run: |
        cd sdk
        export PATH="$(pwd)/staging_dir/toolchain-*/bin:$PATH"
        STRIP=$(find staging_dir -name "*-strip" | head -1)
        $STRIP ../output/trafficmon || true

    - name: Create package folder
      run: |
        cd sdk
        mkdir -p package/trafficmon
        mkdir -p package/trafficmon/files

        cp ../output/trafficmon package/trafficmon/files/
        chmod +x package/trafficmon/files/trafficmon

        cat > package/trafficmon/Makefile << 'EOF'
include $(TOPDIR)/rules.mk

PKG_NAME:=trafficmon
PKG_VERSION:=1.0.0
PKG_RELEASE:=1

PKG_LICENSE:=MIT
PKG_MAINTAINER:=Steven Ke

include $(INCLUDE_DIR)/package.mk

define Package/trafficmon
  SECTION:=net
  CATEGORY:=Network
  TITLE:=Rust Traffic Monitor
  DEPENDS:=+nftables
endef

define Package/trafficmon/install
	$(INSTALL_DIR) $(1)/usr/bin
	$(INSTALL_BIN) ./files/trafficmon $(1)/usr/bin/

	$(INSTALL_DIR) $(1)/etc/init.d
	$(INSTALL_BIN) ./files/trafficmon.init $(1)/etc/init.d/trafficmon

	$(INSTALL_DIR) $(1)/etc/config
	$(INSTALL_CONF) ./files/trafficmon.config $(1)/etc/config/trafficmon
endef

$(eval $(call BuildPackage,trafficmon))
EOF

        cat > package/trafficmon/files/trafficmon.init << 'EOF'
#!/bin/sh /etc/rc.common
START=99
USE_PROCD=1
PROG=/usr/bin/trafficmon

start_service() {
    procd_open_instance
    procd_set_param command $PROG
    procd_close_instance
}
EOF

        cat > package/trafficmon/files/trafficmon.config << 'EOF'
config trafficmon 'config'
	option enabled '1'
	option interfaces 'wan eth1'
	option interval '5'
EOF

        chmod +x package/trafficmon/files/trafficmon.init

    - name: Build package
      run: |
        cd sdk
        make defconfig
        make package/trafficmon/compile V=s -j$(nproc)

    - name: Collect IPK
      run: |
        mkdir -p ipk
        find sdk/bin/packages -name "trafficmon*.ipk" -exec cp {} ipk/ \;
        ls -l ipk

    - name: Upload IPK
      uses: actions/upload-artifact@v4
      with:
        name: trafficmon-${{ matrix.arch }}-ipk
        path: ipk/*.ipk
