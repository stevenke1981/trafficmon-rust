name: Build OpenWrt Rust Package for Filogic Cortex-A53

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  release:
    types: [ published ]

env:
  CARGO_NET_GIT_FETCH_WITH_CLI: true
  RUST_BACKTRACE: full
  TARGET: aarch64_cortex-a53
  OPENWRT_ARCH: aarch64_cortex-a53
  TOOLCHAIN_TRIPLE: aarch64-openwrt-linux-musl

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install System Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          libncurses5-dev \
          libssl-dev \
          python3 \
          python3-pip \
          unzip \
          wget \
          file \
          tar \
          zstd \
          gcc-aarch64-linux-gnu \
          g++-aarch64-linux-gnu

    - name: Install Rust Toolchain
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
        targets: aarch64-unknown-linux-musl
        components: rust-src

    - name: Download OpenWrt SDK for Filogic
      run: |
        SDK_URL="https://archive.openwrt.org/releases/24.10.0/targets/mediatek/filogic/openwrt-sdk-24.10.0-mediatek-filogic_gcc-13.3.0_musl.Linux-x86_64.tar.zst"
        wget -O sdk.tar.zst "$SDK_URL"
        unzstd sdk.tar.zst || tar --use-compress-program=unzstd -xf sdk.tar.zst
        tar -xf sdk.tar
        mv openwrt-sdk-* openwrt-sdk
        echo "SDK_PATH=$(pwd)/openwrt-sdk" >> $GITHUB_ENV
        echo "STAGING_DIR=$(pwd)/openwrt-sdk/staging_dir" >> $GITHUB_ENV

    - name: Setup Cross-Compile Environment
      run: |
        export STAGING_DIR="${{ env.STAGING_DIR }}"
        export PATH="$STAGING_DIR/toolchain-${{ env.TARGET }}_gcc-13.3.0_musl/bin:$PATH"
        
        # 驗證工具鏈
        aarch64-openwrt-linux-musl-gcc --version
        aarch64-linux-gnu-gcc --version
        
        # 設定編譯環境變數
        echo "CARGO_TARGET_AARCH64_CORTEX_A53_LINKER=aarch64-openwrt-linux-musl-gcc" >> $GITHUB_ENV
        echo "CC_aarch64_cortex-a53=aarch64-openwrt-linux-musl-gcc" >> $GITHUB_ENV
        echo "CXX_aarch64_cortex-a53=aarch64-openwrt-linux-musl-g++" >> $GITHUB_ENV
        echo "AR_aarch64_cortex-a53=aarch64-openwrt-linux-musl-ar" >> $GITHUB_ENV

    - name: Create Correct Target Specification
      run: |
        cat > aarch64_cortex-a53.json << 'EOF'
        {
          "arch": "aarch64",
          "data-layout": "e-m:e-i8:8:32-i16:16:32-i64:64-i128:128-n32:64-S128",
          "llvm-target": "aarch64-unknown-linux-musl",
          "target-endian": "little",
          "target-pointer-width": 64,
          "target-c-int-width": "32",
          "os": "linux",
          "env": "musl",
          "vendor": "unknown",
          "linker": "aarch64-openwrt-linux-musl-gcc",
          "linker-flavor": "gcc",
          "cpu": "cortex-a53",
          "features": "+neon,+fp-armv8",
          "dynamic-linking": false,
          "executables": true,
          "position-independent-executables": false,
          "relocation-model": "static",
          "code-model": "small",
          "panic-strategy": "unwind",
          "relro-level": "full",
          "disable-redzone": true,
          "target-family": "unix"
        }
        EOF
        
        # 驗證 JSON 格式
        python3 -c "import json; json.load(open('aarch64_cortex-a53.json')); print('JSON format is valid')"

    - name: Build Rust Package
      run: |
        export STAGING_DIR="${{ env.STAGING_DIR }}"
        export PATH="$STAGING_DIR/toolchain-${{ env.TARGET }}_gcc-13.3.0_musl/bin:$PATH"
        
        # 使用更簡單的 RUSTFLAGS
        export RUSTFLAGS="-C linker=aarch64-openwrt-linux-musl-gcc -C link-arg=-static"
        
        # 嘗試建置
        cargo build --target aarch64_cortex-a53.json --release --verbose

    - name: Create OpenWrt Package Structure
      run: |
        # 建立 OpenWrt 套件目錄結構
        mkdir -p openwrt-package/usr/bin
        mkdir -p openwrt-package/CONTROL
        
        # 複製二進位檔案
        BINARY_NAME=$(find target/aarch64_cortex-a53.json/release -maxdepth 1 -type f -executable | head -1)
        if [ -n "$BINARY_NAME" ]; then
          cp "$BINARY_NAME" openwrt-package/usr/bin/
          chmod +x openwrt-package/usr/bin/$(basename "$BINARY_NAME")
          echo "Binary copied: $(basename "$BINARY_NAME")"
        else
          echo "No binary found, listing directory:"
          find target/aarch64_cortex-a53.json/release -type f || true
        fi
        
        # 建立控制檔案
        cat > openwrt-package/CONTROL/control << EOF
        Package: your-rust-package
        Version: 1.0.0-$(date +%Y%m%d)
        Depends: libc
        Source: your-repo
        Section: utils
        Architecture: ${{ env.OPENWRT_ARCH }}
        Installed-Size: $(stat -c%s "$BINARY_NAME" 2>/dev/null || echo 0)
        Description: Your Rust application for MT7981/MT7986 (Cortex-A53)
        EOF

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-package-cortex-a53
        path: |
          openwrt-package/
          target/aarch64_cortex-a53.json/release/
        retention-days: 30