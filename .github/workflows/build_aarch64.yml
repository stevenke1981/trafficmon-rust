name: Build OpenWrt Rust Package for Filogic Cortex-A53

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  release:
    types: [ published ]

env:
  TARGET: aarch64_cortex-a53
  OPENWRT_ARCH: aarch64_cortex-a53
  TOOLCHAIN_TRIPLE: aarch64-openwrt-linux-musl
  SDK_URL: https://downloads.openwrt.org/releases/24.10.0/targets/mediatek/filogic/openwrt-sdk-24.10.0-mediatek_filogic_gcc-13.3.0_musl.Linux-x86_64.tar.xz

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Install Build Dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential clang llvm libc6-dev-i386 unzip xz-utils gcc-aarch64-linux-gnu

    - name: Download OpenWrt SDK
      run: |
        wget -O sdk.tar.xz $SDK_URL
        tar -xf sdk.tar.xz
        mv openwrt-sdk-* openwrt-sdk

    - name: Set ENV Paths
      run: |
        echo "STAGING_DIR=$GITHUB_WORKSPACE/openwrt-sdk/staging_dir" >> $GITHUB_ENV
        echo "PATH=$GITHUB_WORKSPACE/openwrt-sdk/staging_dir/toolchain-aarch64_generic_gcc-13.3.0_musl/bin:$PATH" >> $GITHUB_ENV

    - name: Verify Toolchain
      run: |
        $TOOLCHAIN_TRIPLE-gcc -v

    - name: Install Rust stable & target
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ env.TARGET }}

    - name: Generate Correct Rust Target JSON
      run: |
        cat > aarch64_cortex-a53.json <<EOF
{
  "llvm-target": "aarch64-unknown-linux-musl",
  "arch": "aarch64",
  "data-layout": "e-m:o-i64:64-i128:128-n32:64-S128",
  "target-pointer-width": "64",
  "target-endian": "little",
  "os": "linux",
  "env": "musl",
  "vendor": "openwrt",
  "linker": "${{ env.TOOLCHAIN_TRIPLE }}-gcc",
  "panic-strategy": "abort",
  "executables": true,
  "linker-flavor": "gcc",
  "cpu": "cortex-a53",
  "features": "+fp-armv8,+neon"
}
EOF

    - name: Build Release Binary
      run: |
        cargo build --release \
          --target $(pwd)/aarch64_cortex-a53.json \
          -Z unstable-options

    - name: Prepare OpenWrt Package Directory
      run: |
        mkdir -p openwrt-package/usr/bin
        cp target/aarch64_cortex-a53/release/* openwrt-package/usr/bin/

        cat > openwrt-package/CONTROL/control <<EOF
Package: trafficmon-rust
Version: 1.0
Depends:
Section: utils
Architecture: ${{ env.OPENWRT_ARCH }}
Description: Rust traffic monitor for MT7981/MT7986 Cortex-A53
EOF

    - name: Build IPK
      run: |
        mkdir ipk
        tar -czf ipk/data.tar.gz -C openwrt-package/ .
        echo "2.0" > ipk/debian-binary
        tar -czf ipk/control.tar.gz -C openwrt-package/CONTROL .

        mkdir -p bin
        ar r bin/trafficmon-rust_${{ env.OPENWRT_ARCH }}.ipk \
          ipk/debian-binary ipk/control.tar.gz ipk/data.tar.gz

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-rust-cortex-a53
        path: |
          bin/
          target/aarch64_cortex-a53/release/
        retention-days: 30
